name: Validate PR
on: 
  pull_request:
    branches: [main]

jobs:
  check-powers-directory:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Check powers/ steering files not modified
        run: |
          # Get list of changed files in PR
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          
          # Check if any steering file in powers/ was modified
          if echo "$CHANGED_FILES" | grep -q "^powers/.*/steering/"; then
            echo "‚ùå ERROR: PRs cannot modify powers/*/steering/ directories"
            echo ""
            echo "‚ÑπÔ∏è  Steering files in powers/ are auto-generated from src/ during build."
            echo "‚ÑπÔ∏è  Only maintainers can update them directly in main branch."
            echo ""
            echo "üìù Modified steering files in powers/:"
            echo "$CHANGED_FILES" | grep "^powers/.*/steering/"
            echo ""
            echo "‚úÖ To fix: Remove powers/*/steering/ changes from your PR"
            echo "‚úÖ Instead, modify source files in src/core/protocols/ or src/kiro/steering/protocols/"
            echo "‚úÖ Maintainers will regenerate powers/ after merge"
            exit 1
          fi
          
          echo "‚úÖ No modifications to powers/*/steering/ directories detected"
      
      - name: Check old power/ directory not used
        run: |
          # Get list of changed files in PR
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          
          # Check if old power/ directory was modified
          if echo "$CHANGED_FILES" | grep -q "^power/"; then
            echo "‚ö†Ô∏è  WARNING: The old power/ directory is obsolete"
            echo ""
            echo "‚ÑπÔ∏è  Use the new powers/ multi-power structure instead"
            echo "‚ÑπÔ∏è  Old power/ directory will be removed in future release"
            echo ""
            echo "üìù Modified files in old power/:"
            echo "$CHANGED_FILES" | grep "^power/"
            echo ""
            echo "‚úÖ To fix: Use powers/ directory for new powers"
            exit 1
          fi
          
          echo "‚úÖ No modifications to obsolete power/ directory"
