name: Validate PR
on: 
  pull_request:
    branches: [main]

jobs:
  check-powers-directory:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Check powers/ steering files not modified
        run: |
          # Get list of changed files in PR
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          
          # Check if any steering file in powers/ was modified
          if echo "$CHANGED_FILES" | grep -q "^powers/.*/steering/"; then
            echo "‚ùå ERROR: PRs cannot modify powers/*/steering/ directories"
            echo ""
            echo "‚ÑπÔ∏è  Steering files in powers/ are auto-generated from src/ during build."
            echo "‚ÑπÔ∏è  Only maintainers can update them directly in main branch."
            echo ""
            echo "üìù Modified steering files in powers/:"
            echo "$CHANGED_FILES" | grep "^powers/.*/steering/"
            echo ""
            echo "‚úÖ To fix: Remove powers/*/steering/ changes from your PR"
            echo "‚úÖ Instead, modify source files in src/core/protocols/ or src/kiro/steering/protocols/"
            echo "‚úÖ Maintainers will regenerate powers/ after merge"
            exit 1
          fi
          
          echo "‚úÖ No modifications to powers/*/steering/ directories detected"
      
      - name: Check test powers not committed
        run: |
          # Get list of changed files in PR
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          
          # Check if test powers were added
          if echo "$CHANGED_FILES" | grep -qE "^powers/(.*-test|test-.*)"; then
            echo "‚ùå ERROR: Test powers should not be committed"
            echo ""
            echo "‚ÑπÔ∏è  Test powers are for local development only"
            echo "‚ÑπÔ∏è  They are automatically ignored by .gitignore"
            echo ""
            echo "üìù Test power files detected:"
            echo "$CHANGED_FILES" | grep -E "^powers/(.*-test|test-.*)"
            echo ""
            echo "‚úÖ To fix: Remove test power directories from your PR"
            echo "‚úÖ Test powers: powers/*-test/ or powers/test-*/"
            exit 1
          fi
          
          echo "‚úÖ No test powers committed"
